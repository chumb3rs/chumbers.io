---
import ContentTypeLayout from '@/layouts/ContentTypeLayout';
import ListPosts from '@/components/ListPosts';
import ContentTypeSelection from '@/components/ContentTypeSelection';
import TabSwitcher from '@/components/TabSwitcher';
import OverviewContent from '@/components/OverviewContent';
import {
    slugify,
    unslugify,
    getAllSeries,
    getPosts,
    getSeries,
    capitalizePhrase
} from '@/utils';
import { siteConfig } from '@/data/site.config';
import Pagination from '@/components/Pagination';
import type { CollectionEntry } from 'astro:content';
import { ContentTypeEnum } from '@/data/utils';

export async function getStaticPaths({ paginate }: any) {
    const allSeries = await getAllSeries();
    const allPosts = await getPosts();

    return allSeries.flatMap((series: CollectionEntry<'series'>) => {
        const {
            data: { title }
        } = series;
        const slugifySeriesName = slugify(title.toLowerCase());
        const filteredPosts = allPosts.filter((post) => {
            // skip posts without a series
            if (!post.data?.series) return false;

            return post.data.series === slugifySeriesName;
        });

        return paginate(filteredPosts, {
            params: {
                series: slugify(title.toLowerCase())
            },
            pageSize: siteConfig.paginationSize
        });
    });
}

const params = Astro.params;
const { page } = Astro.props;
const url = Astro.url;

const seriesTitle = unslugify(params.series!.toLowerCase());
const posts = page.data;

// Get the series entry for overview content
const seriesSlug = slugify(seriesTitle.toLowerCase());
const seriesEntry = await getSeries(seriesSlug);

// Default to 'posts' for server-side rendering
// Client-side JavaScript will handle the correct tab based on URL
const activeTab = 'posts';

// Generate tab URLs
const baseUrl = `/series/${params.series}/${page.currentPage}`;
const tabs = [
    {
        id: 'overview',
        label: 'Overview',
        href: `${baseUrl}?tab=overview`
    },
    {
        id: 'posts',
        label: 'Posts',
        href: `${baseUrl}?tab=posts`
    }
];
---

<ContentTypeLayout contentType='series' title={capitalizePhrase(seriesTitle)}>
    <div class='w-max mx-auto my-4'>
        <ContentTypeSelection
            text={seriesTitle}
            activeOption={seriesTitle}
            slug=''
            type={ContentTypeEnum.Series}
        />
    </div>

    <TabSwitcher tabs={tabs} activeTab={activeTab} />

    {
        seriesEntry && (
            <div class='overview-content tab-content' style='display: none;'>
                <OverviewContent entry={seriesEntry} isVisible={true} />
            </div>
        )
    }

    <div class='posts-content tab-content' style='display: none;'>
        <Pagination page={page} />
        <ListPosts posts={posts} />
    </div>
</ContentTypeLayout>
