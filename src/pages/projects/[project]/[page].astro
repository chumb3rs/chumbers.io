---
import ContentTypeLayout from '@/layouts/ContentTypeLayout';
import ListPosts from '@/components/ListPosts';
import ContentTypeSelection from '@/components/ContentTypeSelection';
import {
    slugify,
    unslugify,
    getAllProjects,
    getPosts,
    capitalizePhrase
} from '@/utils';
import { siteConfig } from '@/data/site.config';
import Pagination from '@/components/Pagination';
import type { CollectionEntry } from 'astro:content';
import { ContentTypeEnum } from '@/data/utils';

export async function getStaticPaths({ paginate }: any) {
    const allProjects = await getAllProjects();
    const allPosts = await getPosts();

    return allProjects.flatMap((project: CollectionEntry<'projects'>) => {
        const {
            data: { title }
        } = project;
        const slugifyProjectName = slugify(title.toLowerCase());
        const filteredPosts = allPosts.filter((post) => {
            // skip posts without a project
            if (!post.data?.project) return false;

            return post.data.project === slugifyProjectName;
        });

        return paginate(filteredPosts, {
            params: {
                project: slugify(title.toLowerCase())
            },
            pageSize: siteConfig.paginationSize
        });
    });
}
const params = Astro.params;
const { page } = Astro.props;

const projectTitle = unslugify(params.project!.toLowerCase());
const posts = page.data;
---

<ContentTypeLayout contentType='project' title={capitalizePhrase(projectTitle)}>
    <div class='w-max mx-auto my-4'>
        <ContentTypeSelection
            text={projectTitle}
            activeOption={projectTitle}
            slug=''
            type={ContentTypeEnum.Projects}
        />
    </div>
    <Pagination page={page} />
    <ListPosts posts={posts} />
</ContentTypeLayout>
