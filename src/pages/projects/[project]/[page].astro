---
import ContentTypeLayout from '@/layouts/ContentTypeLayout';
import ListPosts from '@/components/ListPosts';
import ContentTypeSelection from '@/components/ContentTypeSelection';
import TabSwitcher from '@/components/TabSwitcher';
import OverviewContent from '@/components/OverviewContent';
import {
    slugify,
    unslugify,
    getAllProjects,
    getPosts,
    getProject,
    getProjectStatus,
    capitalizePhrase,
    cn
} from '@/utils';
import { siteConfig } from '@/data/site.config';
import Pagination from '@/components/Pagination';
import type { CollectionEntry } from 'astro:content';
import { ContentTypeEnum, StatusEnum } from '@/data/utils';
import FormattedDate from '@/components/FormattedDate';

export async function getStaticPaths({ paginate }: any) {
    const allProjects = await getAllProjects();
    const allPosts = await getPosts();

    return allProjects.flatMap((project: CollectionEntry<'projects'>) => {
        const {
            data: { title }
        } = project;
        const slugifyProjectName = slugify(title.toLowerCase());
        const filteredPosts = allPosts.filter((post) => {
            // skip posts without a project
            if (!post.data?.project) return false;

            return post.data.project === slugifyProjectName;
        });

        return paginate(filteredPosts, {
            params: {
                project: slugify(title.toLowerCase())
            },
            pageSize: siteConfig.paginationSize
        });
    });
}

const params = Astro.params;
const { page } = Astro.props;

const projectTitle = unslugify(params.project!.toLowerCase());
const posts = page.data;

// Get the project entry for overview content
const projectSlug = slugify(projectTitle.toLowerCase());
const projectEntry = await getProject(projectSlug);

// Default to 'posts' for server-side rendering
// Client-side JavaScript will handle the correct tab based on URL
const activeTab = 'posts';

// Generate tab URLs
const baseUrl = `/projects/${params.project}/${page.currentPage}`;
const tabs = [
    {
        id: 'overview',
        label: 'Overview',
        href: `${baseUrl}?tab=overview`
    },
    {
        id: 'posts',
        label: 'Posts',
        href: `${baseUrl}?tab=posts`
    }
];

const { startDate = '', endDate = '' } = projectEntry?.data;
const projectStatus = getProjectStatus(startDate, endDate);
const statusColors = {
    [StatusEnum.Not_started]: {
        bg: 'hover:bg-red-800/50',
        border: 'border-red-800'
    },
    [StatusEnum.In_progress]: {
        bg: 'hover:bg-yellow-800/50',
        border: 'border-yellow-800'
    },
    [StatusEnum.Completed]: {
        bg: 'hover:bg-green-800/50',
        border: 'border-green-800'
    }
};
---

<ContentTypeLayout contentType='project' title={capitalizePhrase(projectTitle)}>
    <div class='w-max mx-auto my-4'>
        <ContentTypeSelection
            text={projectTitle}
            activeOption={projectTitle}
            slug=''
            type={ContentTypeEnum.Projects}
        />
    </div>

    <!-- project-specific metadata -->
    <div class='flex flex-col justify-center items-center gap-3'>
        <div class='flex items-center gap-1'>
            <p>
                <span class='font-bold'>Start date: </span>{
                    (<FormattedDate date={startDate} />)
                }
            </p>
            {
                endDate != '' && (
                    <p class='text-center text-opacity-50 font-bold'>
                        Â· <span class='font-bold'>End date: </span>
                        {<FormattedDate date={endDate} />}
                    </p>
                )
            }
        </div>
        <p
            aria-label={projectEntry?.data.title}
            class={cn(
                'cursor-default border-2 font-semibold text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-lg transition-all duration-700',
                statusColors[projectStatus].bg,
                statusColors[projectStatus].border
            )}
        >
            {projectStatus}
        </p>
    </div>

    <TabSwitcher tabs={tabs} activeTab={activeTab} />

    <div class='tab-container w-full max-w-full overflow-hidden'>
        {
            projectEntry ? (
                <div
                    class='overview-content tab-content'
                    style='display: none;'
                >
                    <OverviewContent entry={projectEntry} isVisible={true} />
                </div>
            ) : null
        }

        <div class='posts-content tab-content' style='display: none;'>
            <Pagination page={page} />
            <ListPosts posts={posts} />
        </div>
    </div>
</ContentTypeLayout>
