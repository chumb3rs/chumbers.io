---
import ArchiveLayout from '@/layouts/ArchiveLayout';
import Pagination from '@/components/Pagination';
import { getPosts, groupPostsByMonth } from '@/utils';
import { siteConfig } from '@/data/site.config';

export async function getStaticPaths({ paginate }: any) {
    const allPosts = await getPosts();

    // Group posts by year
    const yearMap = new Map<number, any[]>();
    allPosts.forEach((post) => {
        const year = post.data.pubDate.getFullYear();
        if (!yearMap.has(year)) {
            yearMap.set(year, []);
        }
        yearMap.get(year)!.push(post);
    });

    // Create paginated routes for each year
    return Array.from(yearMap.entries()).flatMap(([year, yearPosts]) => {
        return paginate(yearPosts, {
            params: { year: year.toString() },
            pageSize: siteConfig.paginationSize
        });
    });
}

const { year } = Astro.params;
const { page } = Astro.props;

const allPosts = await getPosts();
const yearNumber = parseInt(year!);
const monthsData = groupPostsByMonth(allPosts, yearNumber);
const posts = page.data;
---

<ArchiveLayout currentYear={yearNumber} monthsData={monthsData} posts={posts}>
    <Pagination page={page} />
</ArchiveLayout>
