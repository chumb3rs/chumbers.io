---
import 'notyf/notyf.min.css';
---

<form
    id='newsletter-form'
    class='relative w-full max-w-md mx-auto space-y-3'
    action='/api/subscribe'
    method='POST'
>
    <div
        class='flex items-center rounded-2xl border-2 border-gray-300 transition-colors duration-300 hover:border-teal focus-within:border-primary overflow-hidden hover:border-primary'
    >
        <input
            type='email'
            name='email'
            id='email-input'
            required
            placeholder='Enter your email'
            class='flex-grow bg-transparent px-4 py-3 text-sm focus:outline-none'
        />

        <button
            type='submit'
            id='submit-button'
            class='absolute right-0 h-full px-5 rounded-r-2xl bg-teal font-medium transition-colors duration-300 hover:bg-teal/90 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed'
        >
            <span id='button-text'>Subscribe</span>
            <span id='button-loading' class='hidden'>
                <svg
                    class='animate-spin h-5 w-5 inline'
                    xmlns='http://www.w3.org/2000/svg'
                    fill='none'
                    viewBox='0 0 24 24'
                >
                    <circle
                        class='opacity-25'
                        cx='12'
                        cy='12'
                        r='10'
                        stroke='currentColor'
                        stroke-width='4'></circle>
                    <path
                        class='opacity-75'
                        fill='currentColor'
                        d='M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'
                    ></path>
                </svg>
            </span>
        </button>
    </div>

    <div
        id='form-message'
        class='hidden text-sm p-3 rounded-lg transition-all'
        role='alert'
    >
    </div>
</form>

<script>
    import { Notyf } from 'notyf';

    const notyf = new Notyf({
        duration: 4000,
        position: { x: 'center', y: 'top' },
        dismissible: true
    });

    const form = document.getElementById('newsletter-form') as HTMLFormElement;
    const submitButton = document.getElementById(
        'submit-button'
    ) as HTMLButtonElement;
    const buttonText = document.getElementById(
        'button-text'
    ) as HTMLSpanElement;
    const buttonLoading = document.getElementById(
        'button-loading'
    ) as HTMLSpanElement;
    const emailInput = document.getElementById(
        'email-input'
    ) as HTMLInputElement;
    const messageContainer = document.getElementById(
        'form-message'
    ) as HTMLDivElement;

    function setLoading(isLoading: boolean) {
        submitButton.disabled = isLoading;
        emailInput.disabled = isLoading;

        if (isLoading) {
            buttonText.classList.add('hidden');
            buttonLoading.classList.remove('hidden');
        } else {
            buttonText.classList.remove('hidden');
            buttonLoading.classList.add('hidden');
        }
    }

    function showMessage(message: string, type: 'success' | 'error') {
        messageContainer.textContent = message;
        messageContainer.classList.remove(
            'hidden',
            'bg-green-50',
            'text-green-800',
            'bg-red-50',
            'text-red-800'
        );

        if (type === 'success') {
            messageContainer.classList.add('bg-green-50', 'text-green-800');
        } else {
            messageContainer.classList.add('bg-red-50', 'text-red-800');
        }

        setTimeout(() => {
            messageContainer.classList.add('hidden');
        }, 5000);
    }

    form?.addEventListener('submit', async (e: SubmitEvent) => {
        e.preventDefault();

        const formData = new FormData(form);

        setLoading(true);
        messageContainer.classList.add('hidden');

        try {
            const res = await fetch('/api/subscribe', {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            if (res.ok) {
                showMessage(data.msg || 'Successfully subscribed!', 'success');
                notyf.success({
                    message:
                        "Welcome aboard! ðŸŽ‰ You've been subscribed to our newsletter.",
                    duration: 5000
                });
                form.reset();
            } else {
                showMessage(data.msg || 'Subscription failed.', 'error');
                notyf.error(
                    data.msg || 'Subscription failed. Please try again.'
                );
            }
        } catch (error) {
            console.error('Subscription error:', error);
            showMessage('Something went wrong. Please try again.', 'error');
            notyf.error(
                'Connection error. Please check your connection and try again.'
            );
        } finally {
            setLoading(false);
        }
    });
</script>
