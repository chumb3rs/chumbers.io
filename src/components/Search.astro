---
import '@pagefind/default-ui/css/ui.css';
import SearchIcon from '@/components/icons/SearchIcon';
---

<site-search id='search' class='ms-auto hoverLink'>
    <button
        data-open-modal
        disabled
        class='flex items-center justify-center rounded-md gap-1'
    >
        <SearchIcon />
        <span class='text-md'> Search</span>
    </button>

    <dialog
        aria-label='search'
        class='h-full max-h-full w-full max-w-full border border-zinc-400 bg-white dark:bg-[#0a0910ec] shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md opacity-0'
    >
        <div class='dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6'>
            <button
                data-close-modal
                class='ms-auto cursor-pointer rounded-full bg-black text-white px-4 py-2 dark:bg-white dark:text-black'
            >
                Close
            </button>

            {
                import.meta.env.DEV ? (
                    <div class='mx-auto text-center dark:text-white'>
                        <p>
                            Search is only available in production builds.
                            <br />
                            Try building and previewing the site locally.
                        </p>
                    </div>
                ) : (
                    <div class='search-container dark:text-white'>
                        <div id='pagefind__search' />
                    </div>
                )
            }
        </div>
    </dialog>
</site-search>

<script>
    import { animate } from 'motion';

    class SiteSearch extends HTMLElement {
        dialog;
        dialogFrame;
        openBtn;
        closeBtn;

        constructor() {
            super();

            this.openBtn = this.querySelector('button[data-open-modal]');
            this.closeBtn = this.querySelector('button[data-close-modal]');
            this.dialog = this.querySelector('dialog');
            this.dialogFrame = this.querySelector('.dialog-frame');

            // --- Event bindings ---
            this.openBtn?.addEventListener('click', this.openModal);
            this.closeBtn?.addEventListener('click', this.closeModal);
            this.openBtn.disabled = false;

            // Global shortcut "/"
            window.addEventListener('keydown', (e) => {
                if (e.key === '/' && !this.dialog?.open) {
                    e.preventDefault();
                    this.openModal();
                }
            });

            // Close modal on page navigation
            document.addEventListener('astro:after-swap', () => {
                this.closeModal();
                this.reinitPagefind();
            });

            // Initial Pagefind load
            window.addEventListener('DOMContentLoaded', () => {
                this.reinitPagefind();
            });
        }

        // --- Modal open ---
        openModal = () => {
            this.dialog?.showModal();

            // Animate only *this* dialog
            animate(
                this.dialog,
                {
                    clipPath: [
                        'polygon(0 0, 100% 0, 100% -200%, -200% -200%)',
                        'polygon(0 0, 100% 0, 100% 100%, 0% 100%)'
                    ],
                    opacity: [0, 1]
                },
                { duration: 0.2 }
            );

            document.body.classList.add('overflow-hidden');

            const searchInput = this.querySelector('input');
            if (searchInput) searchInput.focus();

            // Close on click outside
            window.addEventListener('click', this.onWindowClick);
            window.addEventListener('keydown', this.handleEscKey);
        };

        // --- Modal close ---
        closeModal = () => {
            if (!this.dialog?.open) return;
            this.dialog?.close();

            document.body.classList.remove('overflow-hidden');

            window.removeEventListener('click', this.onWindowClick);
            window.removeEventListener('keydown', this.handleEscKey);
        };

        onWindowClick = (event) => {
            // Click is outside dialog frame
            if (
                this.dialog?.open &&
                !this.dialogFrame?.contains(event.target) &&
                event.target !== this.openBtn
            ) {
                this.closeModal();
            }
        };

        handleEscKey = (e) => {
            if (e.key === 'Escape') {
                this.closeModal();
            }
        };

        // --- Pagefind UI re-initialization ---
        async reinitPagefind() {
            if (import.meta.env.DEV) return;

            const container = this.querySelector('#pagefind__search');
            if (!container) return;

            // Clear previous UI (DOM was swapped)
            container.innerHTML = '';

            const onIdle =
                window.requestIdleCallback || ((cb) => setTimeout(cb, 1));

            onIdle(async () => {
                // @ts-ignore
                const { PagefindUI } = await import('@pagefind/default-ui');
                new PagefindUI({
                    element: container,
                    baseUrl: import.meta.env.BASE_URL,
                    bundlePath:
                        import.meta.env.BASE_URL.replace(/\/$/, '') +
                        '/pagefind/',
                    showImages: false,
                    showSubResults: true
                });
            });
        }
    }

    customElements.define('site-search', SiteSearch);
</script>

<style is:global>
    .dark {
        --pagefind-ui-primary: #eeeeee;
        --pagefind-ui-text: #eeeeee;
        --pagefind-ui-background: #152028;
        --pagefind-ui-border: #152028;
        --pagefind-ui-tag: #152028;
    }
</style>
