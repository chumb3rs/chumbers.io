---
import type { CollectionEntry } from 'astro:content';
import FormattedDate from '@/components/FormattedDate';
import BaseLayout from '@/layouts/BaseLayout';
import Tag from '@/components/Tag';
import type { MarkdownHeading } from 'astro';
import { CldImage } from 'astro-cloudinary';
import { slugify } from '@/utils';

type Props = {
    id: CollectionEntry<'posts'>['id'];
    data: CollectionEntry<'posts'>['data'];
    headings: MarkdownHeading[];
    readTime: string;
};

const { data, readTime } = Astro.props;
const {
    title,
    description,
    pubDate,
    heroImage,
    tags,
    category,
    series = null
} = data;

const articleDate = pubDate.toISOString();
---

<BaseLayout
    title={title}
    description={description}
    image={heroImage?.src}
    articleDate={articleDate}
>
    <article class='min-w-full md:py-4 sm:max-w-none md:max-w-none'>
        <header class='mb-3 flex flex-col justify-center items-center gap-6'>
            <div class='flex flex-col gap-2'>
                <div class='text-center text-lg font-mono'>
                    <a class='underline--magical' href='/'>Home</a><span
                        >{' / '}</span
                    ><a
                        class='underline--magical'
                        href={`/categories/${slugify(category.toLowerCase())}`}
                        >{category}</a
                    >
                </div>
                <h1
                    class='text-center text-4xl md:text-6xl md:pb-2.5 font-semibold font-heading'
                >
                    {title}
                </h1>
                <div class='flex items-center justify-center gap-x-1'>
                    <p class='text-center text-sm text-opacity-50'>
                        Published <FormattedDate date={pubDate} />
                    </p>
                    <p class='text-center text-sm text-opacity-50 font-bold'>
                        Â· {readTime}
                    </p>
                </div>
            </div>
            {
                series && (
                    <a
                        href={`/series/${encodeURIComponent(series.toLowerCase())}`}
                        aria-label={series}
                        class='mb-2'
                    >
                        <span class='border-2 border-green-600 dark:border-green-900 font-semibold text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-lg hover:bg-green-600 hover:dark:bg-green-900 transition-all duration-700'>
                            {series}
                        </span>
                    </a>
                )
            }
            <div
                class='flex flex-wrap justify-center items-center gap-2 gap-y-4 md:gap-3'
            >
                {tags.map((tag) => <Tag tag={tag} />)}
            </div>
        </header>

        <>
            {
                heroImage && (
                    <CldImage
                        src={heroImage}
                        alt={`Hero image for ${title}`}
                        crop='fill'
                        gravity='auto'
                        quality='auto'
                        fetchFormat='auto'
                        sizes='(max-width: 768px) 100vw, 1600px'
                        class='w-full rounded-md object-cover my-8 max-h-[300px] md:max-h-[500px]'
                        loading='eager'
                    />
                )
            }
        </>

        <hr />

        <div>
            <slot />
        </div>
    </article>
</BaseLayout>

<script>
    const fnObserver = () => {
        function handleIntersection(
            entries: IntersectionObserverEntry[],
            observer: IntersectionObserver
        ) {
            entries.forEach((entry) => {
                const index = document.querySelector(
                    `aside a[href="#${entry.target.id}"]`
                );

                if (entry.isIntersecting) {
                    index?.classList.remove(
                        'bg-slate-200',
                        'dark:bg-slate-800'
                    ); // remove bg
                    index?.classList.add(
                        'bg-indigo-600',
                        'dark:bg-indigo-700',
                        'text-white',
                        'font-bold',
                        'transition-colors',
                        'duration-200'
                    );
                } else {
                    index?.classList.add('bg-slate-200', 'dark:bg-slate-800'); // add bg
                    index?.classList.remove(
                        'bg-indigo-600',
                        'dark:bg-indigo-700',
                        'text-white',
                        'font-bold',
                        'transition-colors',
                        'duration-200'
                    );
                }
            });
        }

        const headings = document.querySelectorAll(
            'div.prose h1, div.prose h2, div.prose h3, div.prose h4, div.prose h5, div.prose h6'
        );

        const options = {
            root: null,
            rootMargin: ' 15% 0px 0% 0px ',
            threshold: 1
        };

        const observer = new IntersectionObserver(handleIntersection, options);

        headings.forEach((heading) => {
            observer.observe(heading);
        });
    };
    fnObserver();
    document.addEventListener('astro:after-swap', fnObserver);
</script>
